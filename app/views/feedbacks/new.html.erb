<div class="max-w-3xl mx-auto p-6">
  <h1 class="text-2xl font-semibold tracking-tight mb-2">School Transport Feedback — Dehradun Region</h1>
  <p class="text-sm text-stone-500 mb-6">As the regulatory authority, we seek your feedback to ensure safer and more reliable school transport services.</p>

  <% if @feedback.errors.any? %>
    <div class="mb-6 rounded-2xl border border-rose-200 bg-rose-50 px-4 py-3 text-rose-900">
      <div class="font-semibold mb-1"><%= pluralize(@feedback.errors.count, "error") %> prevented submission</div>
      <ul class="list-disc list-inside text-sm">
        <% @feedback.errors.full_messages.each do |m| %>
          <li><%= m %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="bg-white rounded-2xl shadow-sm ring-1 ring-stone-200/60">
    <div class="px-6 py-5 border-b border-stone-100/80 bg-white/70 rounded-t-2xl">
      <h2 class="text-base font-semibold tracking-tight">Submit Feedback</h2>
      <p class="mt-1 text-sm text-stone-500">Fields marked with <span class="text-rose-600">*</span> are required.</p>
    </div>

    <div class="p-6">
      <%= form_with model: @feedback, class: "space-y-6" do |f| %>

        <!-- District & School -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-medium text-stone-700">
              District <span class="text-rose-600">*</span>
            </label>
            <%= f.collection_select :district_id, @districts, :id, :name,
                  { prompt: "Select District" },
                  { class: "mt-1 w-full h-11 rounded-xl border-stone-300 shadow-sm
                           focus:border-indigo-500 focus:ring-indigo-500 px-3",
                    id: "feedback_district_id",
                    required: true } %>
          </div>

          <div>
            <label class="block text-sm font-medium text-stone-700">
              School <span class="text-rose-600">*</span>
            </label>
            <%= f.select :school_id, [],
                  { prompt: "Select School" },
                  { id: "feedback_school_id",
                    class: "mt-1 w-full h-11 rounded-xl border-stone-300 shadow-sm
                           focus:border-indigo-500 focus:ring-indigo-500 px-3
                           disabled:bg-stone-100 disabled:text-stone-500",
                    required: true,
                    disabled: true } %>
            <p class="mt-1 text-xs text-stone-500">Choose the student’s school within the selected district, or select "Other".</p>
          </div>
        </div>

        <!-- Hidden "Other School" input -->
        <div id="other-school-field" class="mt-3 hidden">
          <%= text_field_tag 'feedback[other_school_name]', nil,
                placeholder: "Enter School Name",
                class: "mt-1 w-full rounded-xl border-stone-300 shadow-sm 
                       focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" %>
        </div>

        <!-- Parent + Contact -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-medium text-stone-700">Parent/Guardian Name <span class="text-rose-600">*</span></label>
            <%= f.text_field :parent_name, required: true,
                  placeholder: "e.g., Ramesh Sharma",
                  class: "mt-1 w-full h-11 rounded-xl border-stone-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3" %>
          </div>
          <div>
            <label class="block text-sm font-medium text-stone-700">Contact (Phone/Email) <span class="text-rose-600">*</span></label>
            <%= f.text_field :contact, required: true,
                  pattern: "\\d{10}|[^\\s@]+@[^\\s@]+\\.[^\\s@]+",
                  title: "Enter a 10-digit phone number or a valid email",
                  placeholder: "10-digit phone or email",
                  class: "mt-1 w-full h-11 rounded-xl border-stone-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3" %>
            <p class="mt-1 text-xs text-stone-500">We’ll only use this if we need clarification about your feedback.</p>
          </div>
        </div>

        <!-- Vehicle Number (mandatory) -->
        <div>
          <label class="block text-sm font-medium text-stone-700">Vehicle Number <span class="text-rose-600">*</span></label>
          <%= f.text_field :vehicle_number,
                required: true,
                maxlength: 10,
                pattern: "[A-Z]{2}[0-9]{2}[A-Z]{2}[0-9]{4}",
                title: "Format: UK06PA1234",
                placeholder: "UK07PA1234",
                class: "mt-1 w-full h-11 rounded-xl border-stone-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3" %>
        </div>

        <!-- Vehicle Category (mandatory) -->
        <div>
          <label class="block text-sm font-medium text-stone-700">Vehicle Category <span class="text-rose-600">*</span></label>
          <%= f.select :vehicle_category,
                [["School Bus", "school_bus"], ["Van", "van"], ["Auto", "auto"], ["Others", "others"]],
                { prompt: "Select vehicle type" },
                { required: true,
                  class: "mt-1 w-full h-11 rounded-xl border-stone-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3" } %>
        </div>

        <!-- Overall Rating -->
        <div>
          <label class="block text-sm font-medium text-stone-700 mb-2">Overall Rating</label>
          <div class="flex items-center gap-1 flex-nowrap overflow-x-auto no-scrollbar pr-1">
            <% (1..5).each do |n| %>
              <label class="inline-flex">
                <%= f.radio_button :overall_rating, n, class: "peer sr-only" %>
                <span class="px-2.5 py-1 rounded-lg border border-stone-300 text-sm text-stone-700
                             peer-checked:bg-stone-900 peer-checked:text-white peer-checked:border-stone-900
                             hover:bg-stone-50 cursor-pointer select-none transition"><%= n %></span>
              </label>
            <% end %>
          </div>
        </div>

        <!-- Issues -->
        <fieldset class="rounded-2xl border border-stone-200/70 p-4">
          <legend class="px-1 text-sm font-medium text-stone-700">Issues observed (select all that apply)</legend>
          <div class="mt-2 grid grid-cols-1 sm:grid-cols-2 gap-2">
            <% Feedback::ISSUES.each_key do |k| %>
              <label class="inline-flex items-center gap-2 text-sm">
                <%= check_box_tag 'feedback[issues][]', k, false,
                      id: "issue_#{k}",
                      class: "rounded border-stone-300 text-indigo-600 focus:ring-indigo-500" %>
                <span><%= k.to_s.humanize %></span>
              </label>
            <% end %>
          </div>

          <!-- Hidden text field for Others -->
          <div id="other-issue-field" class="mt-3 hidden">
            <%= text_field_tag 'feedback[other_issue_text]', nil,
                  placeholder: "Please specify the issue",
                  class: "mt-1 w-full rounded-xl border-stone-300 shadow-sm 
                         focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" %>
          </div>
        </fieldset>

        <!-- Appreciation (optional) -->
        <div>
          <label class="block text-sm font-medium text-stone-700">Appreciation / Praise (optional)</label>
          <%= f.text_area :praise_note, rows: 4,
                placeholder: "Share positive feedback about the driver or the school’s transport team.",
                class: "mt-1 w-full rounded-xl border-stone-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2" %>
        </div>

        <!-- Remarks -->
        <div>
          <label class="block text-sm font-medium text-stone-700">Remarks / Details</label>
          <%= f.text_area :comments, rows: 6,
                class: "mt-1 w-full rounded-xl border-stone-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 px-3 py-2",
                placeholder: "Describe the issue or share additional details" %>
        </div>

        <!-- Actions -->
        <div class="flex items-center justify-end gap-3 pt-2">
          <%= link_to "Cancel", feedbacks_path, class: "px-4 py-2 rounded-xl border border-stone-300 text-stone-700 hover:bg-stone-50" %>
          <%= f.submit "Submit Feedback", class: "px-4 py-2 rounded-xl bg-indigo-600 text-white hover:bg-indigo-700 shadow-sm" %>
        </div>

      <% end %>
    </div>
  </div>
</div>

<!-- JS for dynamic schools, Other school, and Other issue -->
<script>
  document.addEventListener("DOMContentLoaded", function() {
    const districtSelect = document.getElementById("feedback_district_id");
    const schoolSelect   = document.getElementById("feedback_school_id");
    const otherSchoolField = document.getElementById("other-school-field");
    const othersCheckbox = document.getElementById("issue_others");
    const otherIssueField = document.getElementById("other-issue-field");

    if (districtSelect && schoolSelect) {
      districtSelect.addEventListener("change", async function() {
        const districtId = this.value;
        schoolSelect.innerHTML = `<option value="">Loading…</option>`;
        schoolSelect.disabled = true;
        otherSchoolField.classList.add("hidden");

        if (!districtId) {
          schoolSelect.innerHTML = `<option value="">Select School</option>`;
          return;
        }

        try {
          const resp = await fetch(`/districts/${districtId}/schools.json`);
          const schools = await resp.json();

          let options = `<option value="">Select School</option>`;
          schools.forEach(s => {
            options += `<option value="${s.id}">${s.name}</option>`;
          });
          schoolSelect.innerHTML = options;
          schoolSelect.disabled = false;
        } catch (err) {
          console.error("Error loading schools:", err);
          schoolSelect.innerHTML = `<option value="">Unable to load schools</option>`;
        }
      });

      schoolSelect.addEventListener("change", function() {
        if (this.value === "other") {
          otherSchoolField.classList.remove("hidden");
        } else {
          otherSchoolField.classList.add("hidden");
        }
      });
    }

    if (othersCheckbox) {
      othersCheckbox.addEventListener("change", function() {
        if (this.checked) {
          otherIssueField.classList.remove("hidden");
        } else {
          otherIssueField.classList.add("hidden");
        }
      });
    }
  });
</script>
